<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estudio del Creador - Likering</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');

        :root {
            --dark-background: #121212;
            --dark-grey: #1a1a1a;
            --light-grey: #2e2e2e;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --plan-azul: #00A4E6;
            --plan-rojo: #F92B75;
            --plan-naranja: #FFA500;
            --plan-verde: #28a745;
            --plan-morado: #8A2BE2;
            --plan-negro: #E0E0E0;
            --plan-amarillo: #FFD700;
            --plan-color-principal: var(--plan-azul);
        }

        .plan-azul { --plan-color-principal: var(--plan-azul); }
        .plan-rojo { --plan-color-principal: var(--plan-rojo); }
        .plan-naranja { --plan-color-principal: var(--plan-naranja); }
        .plan-verde { --plan-color-principal: var(--plan-verde); }
        .plan-morado { --plan-color-principal: var(--plan-morado); }
        .plan-negro { --plan-color-principal: var(--plan-negro); }
        .plan-amarillo { --plan-color-principal: var(--plan-amarillo); }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--dark-background);
            color: var(--text-primary);
        }
        
        /* Contenedor Principal */
        .studio-container {
            display: flex;
            flex-direction: column;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

.create-options-layout {
        display: flex;
        flex-direction: column; /* Apila el botón superior y la fila inferior */
        align-items: center; /* Centra todo horizontalmente */
        gap: 20px; /* Espacio entre el botón superior y la fila inferior */
        margin-top: 50px;
    }

    /* Fila que contiene los dos botones de abajo */
    .bottom-options-row {
        display: flex;
        justify-content: center; /* Centra los botones en la fila */
        gap: 20px; /* Espacio entre los dos botones */
        width: 100%;
        max-width: 520px; /* Limita el ancho máximo para que coincida con el botón superior */
    }

    /* Estilo general para todas las tarjetas de opción */
    .create-option-card {
        height: 220px;
        background: var(--dark-grey);
        border-radius: 15px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: 2px dashed var(--light-grey);
        transition: all 0.3s;
        text-align: center;
        padding: 20px;
    }

    /* Estilo específico para el botón superior */
    #upload-gallery-btn {
        width: 100%;
        max-width: 520px; /* Ancho máximo para el botón superior */
        height: 160px;   /* Hacemos el botón superior un poco más bajo */
    }

    /* Estilo específico para los dos botones inferiores */
    .bottom-options-row .create-option-card {
        flex: 1; /* Asegura que ambos botones compartan el espacio por igual */
    }

    .create-option-card:hover {
        border-color: var(--plan-color-principal);
        transform: translateY(-5px);
    }
    .create-option-card i {
        font-size: 2.5rem; /* Ajuste ligero del tamaño del icono */
        margin-bottom: 15px;
        color: var(--plan-color-principal);
    }
    .create-option-card span {
        font-size: 1.1rem; /* Ajuste ligero del tamaño de la fuente */
        font-weight: 600;
    }
    
        /* --- NUEVA NAVEGACIÓN --- */
        .studio-header {
            background: var(--dark-grey);
            padding: 15px 20px;
            border-bottom: 1px solid var(--light-grey);
            flex-shrink: 0;
        }
        
        .profile-nav-link {
            display: block;
            background: var(--light-grey);
            color: var(--text-primary);
            text-decoration: none;
            padding: 15px 20px;
            border-radius: 12px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        .profile-nav-link:hover {
            background: var(--plan-color-principal);
            transform: scale(1.02);
        }
        .profile-nav-link i {
            margin-right: 10px;
        }

        .main-nav-buttons {
            display: flex;
            gap: 15px;
        }

      .nav-item {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            background: var(--light-grey);
            color: var(--text-secondary);
            font-weight: 600;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            /* --- Nuevas propiedades para centrar y ordenar --- */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 6px; /* Espacio entre el icono y el texto */
        }
        .nav-item:hover {
            color: var(--text-primary);
            border-color: var(--plan-color-principal);
        }
        .nav-item.active {
            background: var(--plan-color-principal);
            color: white;
            border-color: var(--plan-color-principal);
        }
        .nav-item i {
            margin-right: 0; /* Quita el margen lateral anterior */
            font-size: 1.2rem; /* Aumenta un poco el tamaño del icono */
        }

        /* --- CONTENIDO DE PÁGINAS --- */
        .studio-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
        }
        .studio-page { display: none; }
        .studio-page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .page-header {
            font-size: 2rem; font-weight: 700; margin-bottom: 30px;
            border-bottom: 2px solid var(--plan-color-principal);
            padding-bottom: 10px; display: inline-block;
        }
        
        /* Estilos generales de botones */
        .btn { padding: 12px 20px; border-radius: 10px; font-weight: 600; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease; border: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background: var(--plan-color-principal); color: white; }
        .btn-primary:hover { filter: brightness(1.1); transform: translateY(-2px); }
        .btn-secondary { background: var(--light-grey); color: var(--text-primary); }
        .btn-secondary:hover { background: #3a3a3a; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

        /* Dashboard & Videos */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--dark-grey); padding: 25px; border-radius: 15px; border-left: 5px solid var(--plan-color-principal); }
        .stat-card .label { color: var(--text-secondary); font-size: 0.9rem; }
        .stat-card .value { font-size: 2.5rem; font-weight: 700; }
        .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .chart-container { background: var(--dark-grey); padding: 20px; border-radius: 15px; }

        .video-list { display: flex; flex-direction: column; gap: 15px; }
        .video-item { display: flex; align-items: center; background: var(--dark-grey); padding: 15px; border-radius: 10px; gap: 15px; }
        .video-item img { width: 120px; aspect-ratio: 16/9; object-fit: cover; border-radius: 5px; }
        .video-details { flex-grow: 1; }
        .video-title { font-weight: 600; }
        .video-desc { font-size: 0.85rem; color: var(--text-secondary); }
        .video-actions {
                        display: flex;
                        flex-direction: column; /* Apila los botones verticalmente */
                        gap: 10px; /* Espacio entre el botón de editar y el de eliminar */
                    }

                    .video-actions button {
                        background: var(--light-grey);
                        border: none;
                        color: white;
                        width: 40px;
                        height: 40px;
                        border-radius: 50%;
                        cursor: pointer;
                        /* Se elimina el margin-left: 10px; para que el 'gap' controle el espacio */
                        transition: background 0.3s;
                    }
        .video-actions button:hover { background: var(--plan-color-principal); }

        /* Crear */
        .create-options { display: flex; gap: 20px; justify-content: center; margin-top: 50px; flex-wrap: wrap; }
        .create-option-card { width: 250px; height: 250px; background: var(--dark-grey); border-radius: 15px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; border: 2px dashed var(--light-grey); transition: all 0.3s; }
        .create-option-card:hover { border-color: var(--plan-color-principal); transform: translateY(-5px); }
        .create-option-card i { font-size: 3rem; margin-bottom: 15px; color: var(--plan-color-principal); }
        .create-option-card span { font-size: 1.2rem; font-weight: 600; }

        /* Secciones flotantes (cámara, preview, upload) */
        .floating-section { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 100; display: none; justify-content: center; align-items: center; flex-direction: column; }
        #camera-video-element { width: 100%; height: 100%; object-fit: cover; }
        .camera-controls { position: absolute; bottom: 30px; left: 0; width: 100%; display: flex; justify-content: space-around; align-items: center; }
        .cam-btn { width: 70px; height: 70px; border-radius: 50%; border: 4px solid white; background: rgba(255, 255, 255, 0.3); cursor: pointer; transition: background-color 0.3s; }
        .cam-btn.recording { background: red; animation: pulse 1.2s infinite; }
        #shutter-btn { background-color: #fff; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,0,0,0.7); } 100% { box-shadow: 0 0 0 15px rgba(255,0,0,0); } }
        
        .side-btn { background: rgba(255,255,255,0.2); border: none; color: white; width: 50px; height: 50px; border-radius: 50%; font-size: 1.3rem; cursor: pointer; transition: background 0.3s; }
        .side-btn:hover, .side-btn.active { background: rgba(255,255,255,0.4); }
        .zoom-controls { position: absolute; bottom: 120px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.5); padding: 5px; border-radius: 20px; display: flex; gap: 10px; }
        .zoom-option { background: transparent; border: none; color: white; padding: 5px 10px; border-radius: 15px; cursor: pointer; font-weight: 600; }
        .zoom-option.active { background: white; color: black; }
        #camera-cancel-btn { position: absolute; top: 30px; left: 30px; }
        .camera-top-bar { position: absolute; top: 30px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .duration-controls button, .timer-display { background: rgba(0,0,0,0.5); border: none; color: white; padding: 8px 15px; border-radius: 20px; font-weight: 600; cursor: pointer; }
        .duration-controls button.active { background: var(--plan-color-principal); }
        .timer-display { display: none; cursor: default; }

        #preview-video { max-width: 90%; max-height: 70%; border-radius: 15px; }
        .upload-form { width: 90%; max-width: 500px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary); }
        .form-group input, .form-group textarea { width: 100%; padding: 12px; background: var(--dark-grey); border: 1px solid var(--light-grey); border-radius: 10px; color: white; font-size: 1rem; }
        .form-group textarea { min-height: 100px; resize: vertical; }
        
        .thumbnail-options { display: flex; gap: 10px; margin-bottom: 10px; }
        .thumbnail-option { flex: 1; padding: 15px; background: var(--dark-grey); border: 2px solid var(--light-grey); border-radius: 10px; cursor: pointer; text-align: center; transition: all 0.3s ease; }
        .thumbnail-option.selected { border-color: var(--plan-color-principal); color: var(--plan-color-principal); }
        #thumbnail-preview { max-width: 150px; border-radius: 8px; margin-top: 15px; border: 2px solid var(--light-grey); }

        .action-buttons { display: flex; gap: 15px; margin-top: 20px; justify-content: center; width: 100%; }
        
        /* Modals (Música, Editar, Alertas) */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); z-index: 105; display: none; justify-content: center; align-items: center; }
        .modal-content { background: var(--dark-grey); border-radius: 15px; padding: 30px; width: 90%; max-width: 450px; text-align: center; }
        .modal-content h2 { margin-bottom: 20px; }
        .music-search-bar { display: flex; gap: 10px; margin-bottom: 15px; }
        .music-search-bar input { flex-grow: 1; padding: 12px; background: #2e2e2e; border: 1px solid var(--light-grey); border-radius: 10px; color: white; font-size: 1rem; }
        #music-results { flex-grow: 1; overflow-y: auto; text-align: left; }
        .music-item { display: flex; align-items: center; gap: 15px; padding: 10px; border-bottom: 1px solid var(--light-grey); }
        .music-item-info { flex-grow: 1; min-width: 0; }
        .music-item-name { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #music-preview-player { width: 100%; margin-top: 10px; }
        
        #alert-modal-message { margin-bottom: 25px; font-size: 1.1rem; line-height: 1.5; }
        .modal-icon { font-size: 3rem; margin-bottom: 15px; }
        .modal-icon.success { color: var(--plan-verde); }
        .modal-icon.error { color: var(--plan-rojo); }
        .modal-icon.confirm { color: var(--plan-amarillo); }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div class="studio-container">
        <header class="studio-header">
            <a href="perfil.html" class="profile-nav-link">
                <i class="fas fa-user-circle"></i>
                <span>Volver a Mi Perfil</span>
            </a>
                <div class="main-nav-buttons">
                    <div class="nav-item active" data-page="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </div>
                    <div class="nav-item" data-page="videos">
                        <i class="fas fa-film"></i>
                        <span>Videos</span>
                    </div>
                    <div class="nav-item" data-page="create">
                        <i class="fas fa-plus-square"></i>
                        <span>Crear</span>
                    </div>
                </div>
        </header>

        <main class="studio-content">
            <div id="dashboard" class="studio-page active">
                <h1 class="page-header">Dashboard</h1>
                <div class="stats-grid">
                    <div class="stat-card"><div class="label">Visualizaciones Totales</div><div class="value" id="total-views">0</div></div>
                    <div class="stat-card"><div class="label">Likes Totales</div><div class="value" id="total-likes">0</div></div>
                </div>
                <div class="charts-grid">
                    <div class="chart-container"><canvas id="views-chart"></canvas></div>
                    <div class="chart-container"><canvas id="likes-chart"></canvas></div>
                </div>
            </div>
            <div id="videos" class="studio-page"><h1 class="page-header">Mis Videos</h1><div class="video-list" id="video-list-container"></div></div>
           <div id="create" class="studio-page">
                <h1 class="page-header">Crear Contenido</h1>
                
                <div class="create-options-layout">
                    <div class="create-option-card" id="upload-gallery-btn">
                        <i class="fas fa-images"></i><span>Subir de Galería</span>
                        <input type="file" id="gallery-file-input" class="hidden" accept="video/*">
                    </div>
                    
                    <div class="bottom-options-row">
                        <div class="create-option-card" id="record-video-btn">
                            <i class="fas fa-video"></i><span>Grabar Contenido</span>
                        </div>
                        <div class="create-option-card" id="take-photo-btn">
                            <i class="fas fa-camera"></i><span>Tomar Foto</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

<section id="camera-section" class="floating-section">
    <video id="camera-video-element" autoplay playsinline muted></video>
    <canvas id="photo-canvas" class="hidden"></canvas>
    <button id="camera-cancel-btn" class="side-btn"><i class="fas fa-times"></i></button>
    <div class="camera-top-bar">
        <div class="duration-controls"><button data-duration="30">30s</button><button data-duration="60">60s</button></div>
        <div class="timer-display" id="timer-display">00:00</div>
    </div>
    <div class="zoom-controls">
        <button class="zoom-option" data-zoom="0.5">0.5x</button>
        <button class="zoom-option active" data-zoom="1">1x</button>
        <button class="zoom-option" data-zoom="2">2x</button>
        <button class="zoom-option" data-zoom="3">3x</button>
    </div>
    <div class="camera-controls">
        <button class="side-btn" id="flash-btn"><i class="fas fa-bolt"></i></button>
        <button class="cam-btn" id="record-btn"></button>
        <button class="cam-btn hidden" id="shutter-btn"><i class="fas fa-camera"></i></button>
        <button class="side-btn" id="switch-camera-btn"><i class="fas fa-sync-alt"></i></button>
    </div>
</section>

    <section id="preview-section" class="floating-section">
        <h1 class="page-header">Previsualización</h1><video id="preview-video" controls></video>
        <div class="action-buttons">
            <button class="btn btn-secondary" id="preview-cancel-btn">Cancelar</button>
            <button class="btn btn-primary" id="preview-next-btn">Siguiente</button>
        </div>
    </section>

    <section id="upload-section" class="floating-section">
        <h1 class="page-header">Publicar Video</h1>
        <div class="upload-form">
            <div class="form-group"><input type="text" id="upload-title" placeholder="Título del video"></div>
            <div class="form-group"><textarea id="upload-description" placeholder="Añade una descripción..."></textarea></div>
            
            <div id="thumbnail-form-group" class="form-group">
                <label>Miniatura</label>
                <div class="thumbnail-options">
                    <div class="thumbnail-option selected" id="thumb-option-auto">
                        <i class="fas fa-magic"></i> A base del video
                    </div>
                    <div class="thumbnail-option" id="thumb-option-custom">
                        <i class="fas fa-upload"></i> Seleccionar imagen
                    </div>
                </div>
                <input type="file" id="thumbnail-file-input" class="hidden" accept="image/*">
                <div style="text-align: center;">
                    <img id="thumbnail-preview" class="hidden" src="#" alt="Vista previa de la miniatura">
                </div>
            </div>

            <div class="form-group">
                <button class="btn btn-secondary" id="open-music-modal-btn" style="width: 100%;"><i class="fas fa-music"></i> Escoger Música</button>
                <p id="selected-music-info" style="margin-top: 10px; color: var(--text-secondary);"></p>
            </div>
            <div class="action-buttons">
                <button class="btn btn-secondary" id="upload-cancel-btn">Cancelar</button>
                <button class="btn btn-primary" id="upload-submit-btn">Publicar</button>
            </div>
        </div>
    </section>

    <div id="music-modal" class="modal"><div class="modal-content" style="height: 80%; width: 90%; max-width: 600px; display: flex; flex-direction: column;">
        <h2 style="margin-bottom: 20px;">Buscar Música</h2>
        <div class="music-search-bar">
            <input type="text" id="music-search-input" placeholder="Buscar canción..."><button class="btn btn-primary" id="music-search-btn"><i class="fas fa-search"></i></button>
        </div>
        <div id="music-results" style="flex-grow: 1; overflow-y: auto;"></div>
        <audio id="music-preview-player" controls style="width: 100%; margin-top: 10px;"></audio>
        <button class="btn btn-secondary" id="close-music-modal-btn" style="margin-top: 20px;">Cerrar</button>
    </div></div>
    
    <div id="edit-video-modal" class="modal"><div class="modal-content">
        <h2>Editar Video</h2><input type="hidden" id="edit-video-id">
        <div class="form-group"><input type="text" id="edit-video-title" placeholder="Nuevo título"></div>
        <div class="form-group"><textarea id="edit-video-description" placeholder="Nueva descripción"></textarea></div>
        <div class="action-buttons">
            <button class="btn btn-secondary" id="cancel-edit-btn">Cancelar</button>
            <button class="btn btn-primary" id="save-edit-btn">Guardar</button>
        </div>
    </div></div>
    
    <div id="loading-spinner" class="modal" style="background: rgba(0,0,0,0.85); z-index: 200;"><i class="fas fa-spinner fa-spin" style="color: white; font-size: 3rem;"></i></div>

    <div id="alert-modal" class="modal"><div class="modal-content">
        <div id="alert-modal-icon" class="modal-icon"></div>
        <h2 id="alert-modal-title"></h2>
        <p id="alert-modal-message"></p>
        <div class="action-buttons" id="alert-modal-buttons"></div>
    </div></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- CONFIGURACIÓN Y VARIABLES GLOBALES ---
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyck3vesbAdynXl5OJdua80iQo1Ju6fHZaYd_mslNmCbrcw4nx1RVc2xEQQHsy3Lt0kDg/exec';
    const FREESOUND_API_KEY = "6Yj8qfEAgJyyx6Xqn3aIktmdDICLMValMS0Cdl0w";
    const CLOUDINARY_UPLOAD_URL = "https://api.cloudinary.com/v1_1/dc7s64lvz/video/upload";
    const CLOUDINARY_IMAGE_UPLOAD_URL = "https://api.cloudinary.com/v1_1/dc7s64lvz/image/upload";
    const CLOUDINARY_UPLOAD_PRESET = "my_unsigned_preset";

    let loggedInUser, userVideos = [], mediaRecorder, recordedBlobs, currentStream, videoFileToUpload, photoFileToUpload, customThumbnailFile;
    let recordingTimer, selectedDuration = 0;
    let selectedMusic = { name: '', url: '' };
    let currentFacingMode = 'user'; 
    let isFlashOn = false;
    let cameraMode = 'video'; // 'video' or 'photo'

    // --- INICIALIZACIÓN ---
    (() => {
        loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
        if (!loggedInUser) { window.location.href = 'index.html'; return; }
        document.body.className = `plan-${loggedInUser.plan.toLowerCase()}`;
        setupEventListeners();
        navigateToPage('dashboard');
    })();

    // --- NUEVO SISTEMA DE MODALES ---
    const alertModal = document.getElementById('alert-modal');
    function showAlert(title, message, type = 'info') {
        alertModal.querySelector('#alert-modal-title').textContent = title;
        alertModal.querySelector('#alert-modal-message').textContent = message;
        const icon = alertModal.querySelector('#alert-modal-icon');
        const buttons = alertModal.querySelector('#alert-modal-buttons');
        
        icon.className = `modal-icon ${type}`;
        if (type === 'success') icon.innerHTML = '<i class="fas fa-check-circle"></i>';
        else if (type === 'error') icon.innerHTML = '<i class="fas fa-times-circle"></i>';
        else icon.innerHTML = '<i class="fas fa-info-circle"></i>';

        buttons.innerHTML = '<button class="btn btn-primary">Aceptar</button>';
        buttons.querySelector('button').onclick = () => alertModal.style.display = 'none';
        
        alertModal.style.display = 'flex';
    }

    function showConfirm(title, message, onConfirm) {
        alertModal.querySelector('#alert-modal-title').textContent = title;
        alertModal.querySelector('#alert-modal-message').textContent = message;
        const icon = alertModal.querySelector('#alert-modal-icon');
        const buttons = alertModal.querySelector('#alert-modal-buttons');
        
        icon.className = 'modal-icon confirm';
        icon.innerHTML = '<i class="fas fa-question-circle"></i>';
        
        buttons.innerHTML = `
            <button class="btn btn-secondary" id="confirm-cancel">Cancelar</button>
            <button class="btn btn-primary" id="confirm-ok">Confirmar</button>
        `;
        buttons.querySelector('#confirm-cancel').onclick = () => alertModal.style.display = 'none';
        buttons.querySelector('#confirm-ok').onclick = () => {
            alertModal.style.display = 'none';
            onConfirm();
        };

        alertModal.style.display = 'flex';
    }

    // --- NAVEGACIÓN ---
    function navigateToPage(pageId) {
        document.querySelectorAll('.studio-page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.querySelector(`.nav-item[data-page="${pageId}"]`).classList.add('active');
        if (pageId === 'dashboard' || pageId === 'videos') fetchUserVideos();
    }

    // --- DATOS Y GRÁFICAS ---
    async function fetchUserVideos() {
        showSpinner(true);
        try {
            const params = new URLSearchParams({ action: 'getVideosForUser', user: loggedInUser.username });
            const response = await fetch(`${SCRIPT_URL}?${params.toString()}`);
            const result = await response.json();
            userVideos = result.success ? result.data : [];
            updateDashboard();
            updateVideoListPage();
        } catch (error) {
            console.error("Error fetching videos:", error);
            showAlert("Error de Red", "No se pudieron cargar los datos de tus videos. Revisa tu conexión.", "error");
        } finally {
            showSpinner(false);
        }
    }

    function updateDashboard() {
        const totalViews = userVideos.reduce((sum, v) => sum + (v.visualizaciones || 0), 0);
        const totalLikes = userVideos.reduce((sum, v) => sum + (v.likes || 0), 0);
        document.getElementById('total-views').textContent = totalViews.toLocaleString('es-ES');
        document.getElementById('total-likes').textContent = totalLikes.toLocaleString('es-ES');
        const last4Videos = userVideos.slice(-4);
        createChart('views-chart', 'Visualizaciones', last4Videos.map(v => v.titulo.substring(0,12)), last4Videos.map(v => v.visualizaciones), '#00A4E6');
        createChart('likes-chart', 'Likes', last4Videos.map(v => v.titulo.substring(0,12)), last4Videos.map(v => v.likes), '#F92B75');
    }
    
    function createChart(canvasId, label, labels, data, color) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (Chart.getChart(canvasId)) Chart.getChart(canvasId).destroy();
        new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label, data, backgroundColor: color }] }, options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { ticks: { color: 'white' } }, x: { ticks: { color: 'white' } } } } });
    }

    // --- GESTIÓN DE VIDEOS ---
    function updateVideoListPage() {
        const container = document.getElementById('video-list-container');
        container.innerHTML = userVideos.length ? userVideos.map(v => `
            <div class="video-item" data-video-id="${v.videoId}">
                <img src="${v.thumbnailUrl}" alt="${v.titulo}">
                <div class="video-details"><div class="video-title">${v.titulo}</div><div class="video-desc">${v.descripcion || 'Sin descripción'}</div></div>
                <div class="video-actions"><button class="edit-btn"><i class="fas fa-edit"></i></button><button class="delete-btn"><i class="fas fa-trash"></i></button></div>
            </div>`).join('') : '<p>Aún no has subido videos.</p>';
    }

    function handleVideoListClick(e) {
        const videoId = e.target.closest('.video-item')?.dataset.videoId;
        if (!videoId) return;
        if (e.target.closest('.edit-btn')) {
            const video = userVideos.find(v => v.videoId === videoId);
            const modal = document.getElementById('edit-video-modal');
            modal.querySelector('#edit-video-id').value = videoId;
            modal.querySelector('#edit-video-title').value = video.titulo;
            modal.querySelector('#edit-video-description').value = video.descripcion;
            modal.style.display = 'flex';
        }
        if (e.target.closest('.delete-btn')) {
            showConfirm("Confirmar Eliminación", "¿Estás seguro de que quieres eliminar este video? Esta acción no se puede deshacer.", () => {
                deleteVideo(videoId);
            });
        }
    }

    async function saveVideoEdit() {
        showSpinner(true);
        const videoId = document.getElementById('edit-video-id').value;
        const newTitle = document.getElementById('edit-video-title').value;
        const newDescription = document.getElementById('edit-video-description').value;
        try {
            const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'editVideoDetails', videoId, newTitle, newDescription }) });
            const result = await res.json();
            if (!result.success) throw new Error(result.message);
            showAlert('Éxito', 'Video actualizado correctamente.', 'success');
            document.getElementById('edit-video-modal').style.display = 'none';
            fetchUserVideos();
        } catch(error) { showAlert('Error', 'No se pudo guardar la edición: ' + error.message, 'error'); } finally { showSpinner(false); }
    }

    async function deleteVideo(videoId) {
        showSpinner(true);
        try {
            const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'deleteVideo', videoId }) });
            const result = await res.json();
            if (!result.success) throw new Error(result.message);
            showAlert('Éxito', 'Video eliminado correctamente.', 'success');
            fetchUserVideos();
        } catch(error) { showAlert('Error', 'No se pudo eliminar el video: ' + error.message, 'error'); } finally { showSpinner(false); }
    }
    
    // --- Lógica de prevención de zoom de pellizco ---
    function preventPinchZoom(e) {
        if (e.touches.length > 1) {
            e.preventDefault();
        }
    }

    // --- GRABACIÓN Y CÁMARA ---
    function openCamera(mode = 'video', facing = 'user') {
        cameraMode = mode;
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
        }
        
        // UI Setup
        document.getElementById('record-btn').classList.toggle('hidden', mode !== 'video');
        document.querySelector('.duration-controls').classList.toggle('hidden', mode !== 'video');
        document.getElementById('shutter-btn').classList.toggle('hidden', mode !== 'photo');

        document.getElementById('camera-section').style.display = 'flex';
        document.body.addEventListener('touchmove', preventPinchZoom, { passive: false });

        navigator.mediaDevices.getUserMedia({ audio: true, video: { facingMode: facing } })
            .then(stream => {
                currentStream = stream;
                document.getElementById('camera-video-element').srcObject = stream;
                document.querySelectorAll('.zoom-option').forEach(b => b.classList.remove('active'));
                document.querySelector('.zoom-option[data-zoom="1"]').classList.add('active');
                document.getElementById('flash-btn').classList.remove('active');
                isFlashOn = false;
            })
            .catch(e => {
                console.error("Error al acceder a la cámara:", e);
                showAlert("Error de Cámara", "No se pudo acceder a la cámara. Revisa los permisos.", "error");
                closeCamera();
            });
    }
    
    function takePhoto() {
        const canvas = document.getElementById('photo-canvas');
        const video = document.getElementById('camera-video-element');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
        closeCamera();
        canvas.toBlob(blob => {
            photoFileToUpload = blob;
            videoFileToUpload = null; // Ensure we're in photo mode
            // Show upload screen configured for photo
            document.getElementById('thumbnail-form-group').classList.add('hidden');
            document.getElementById('open-music-modal-btn').classList.add('hidden');
            document.getElementById('upload-section').style.display = 'flex';
        }, 'image/jpeg');
    }

    function closeCamera() {
        if(currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
        }
        document.getElementById('camera-section').style.display = 'none';
        document.body.removeEventListener('touchmove', preventPinchZoom);
        currentStream = null;
    }

    async function applyZoom(zoomValue) {
        if (!currentStream) return;
        const videoTrack = currentStream.getVideoTracks()[0];
        if (!videoTrack) return;
        try {
            const capabilities = videoTrack.getCapabilities();
            if (capabilities.zoom) await videoTrack.applyConstraints({ advanced: [{ zoom: zoomValue }] });
            else console.warn('El zoom no es compatible.');
        } catch (error) { console.error('Error al aplicar el zoom:', error); }
    }
    
    async function toggleFlash() {
        if (!currentStream) return;
        const videoTrack = currentStream.getVideoTracks()[0];
        if (!videoTrack) return;
        const flashBtn = document.getElementById('flash-btn');
        try {
            const capabilities = videoTrack.getCapabilities();
            if (capabilities.torch) {
                const newFlashState = !isFlashOn;
                await videoTrack.applyConstraints({ advanced: [{ torch: newFlashState }] });
                isFlashOn = newFlashState;
                flashBtn.classList.toggle('active', isFlashOn);
            } else showAlert('Función no disponible', 'El flash no es compatible con este dispositivo o cámara.', 'error');
        } catch (error) { showAlert('Error de Flash', 'No se pudo cambiar el estado del flash.', 'error'); }
    }

    function switchCamera() {
        currentFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user';
        openCamera(cameraMode, currentFacingMode);
    }

    function startRecording() {
        recordedBlobs = [];
        try { mediaRecorder = new MediaRecorder(currentStream, { mimeType: 'video/webm' }); } 
        catch (e) { console.error('MediaRecorder error:', e); return; }
        mediaRecorder.onstop = () => showPreviewScreen(new Blob(recordedBlobs, { type: 'video/webm' }));
        mediaRecorder.ondataavailable = e => { if (e.data && e.data.size > 0) recordedBlobs.push(e.data); };
        mediaRecorder.start();
        document.getElementById('record-btn').classList.add('recording');
        if (selectedDuration > 0) {
            let timeLeft = selectedDuration;
            const timerDisplay = document.getElementById('timer-display');
            timerDisplay.style.display = 'block';
            recordingTimer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = `00:${String(timeLeft).padStart(2, '0')}`;
                if (timeLeft <= 0) stopRecording();
            }, 1000);
        }
    }
    function stopRecording() {
        if (mediaRecorder && mediaRecorder.state === 'recording') mediaRecorder.stop();
        clearInterval(recordingTimer);
        document.getElementById('record-btn').classList.remove('recording');
        document.getElementById('timer-display').style.display = 'none';
        closeCamera();
    }
    
    // --- LÓGICA DE SUBIDA ---
    function showPreviewScreen(blob) {
        videoFileToUpload = blob;
        photoFileToUpload = null; // Ensure we're in video mode
        document.getElementById('preview-video').src = URL.createObjectURL(blob);
        document.getElementById('preview-section').style.display = 'flex';
    }

    function resetUploadProcess() {
        document.querySelectorAll('.floating-section').forEach(s => s.style.display = 'none');
        document.getElementById('upload-title').value = '';
        document.getElementById('upload-description').value = '';
        document.getElementById('selected-music-info').textContent = '';
        document.getElementById('gallery-file-input').value = ''; 
        document.getElementById('thumbnail-file-input').value = '';
        document.getElementById('thumbnail-preview').classList.add('hidden');
        document.getElementById('thumb-option-auto').classList.add('selected');
        document.getElementById('thumb-option-custom').classList.remove('selected');
        document.getElementById('thumbnail-form-group').classList.remove('hidden');
        document.getElementById('open-music-modal-btn').classList.remove('hidden');

        videoFileToUpload = null;
        photoFileToUpload = null;
        customThumbnailFile = null;
        selectedMusic = { name: '', url: '' };
        const musicPreviewPlayer = document.getElementById('music-preview-player');
        if (musicPreviewPlayer) { musicPreviewPlayer.pause(); musicPreviewPlayer.src = ''; }
    }
    
    async function submitUpload() {
        const title = document.getElementById('upload-title').value;
        const description = document.getElementById('upload-description').value;
        if (!title || (!videoFileToUpload && !photoFileToUpload)) return showAlert('Datos incompletos', 'El título y el contenido son obligatorios.', 'error');
        
        showSpinner(true);
        document.getElementById('upload-submit-btn').disabled = true;

        try {
            let finalVideoUrl, thumbnailUrl;
            const CLOUDINARY_BASE_URL = `https://res.cloudinary.com/dc7s64lvz/video/upload/`;
            const CLOUDINARY_IMAGE_BASE_URL = `https://res.cloudinary.com/dc7s64lvz/image/upload/`;

            // Handle photo upload
            if (photoFileToUpload) {
                const photoFormData = new FormData();
                photoFormData.append('file', photoFileToUpload);
                photoFormData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                const imageRes = await fetch(CLOUDINARY_IMAGE_UPLOAD_URL, { method: 'POST', body: photoFormData });
                const imageData = await imageRes.json();
                if (!imageData.public_id) throw new Error("Error en la subida de la foto.");
                
                thumbnailUrl = imageData.secure_url;
                // Create a 3-second video from the image
                finalVideoUrl = `${CLOUDINARY_IMAGE_BASE_URL}du_3/f_mp4,vc_h264,ac_aac/${imageData.public_id}.mp4`;
            
            // Handle video upload
            } else {
                if(customThumbnailFile) {
                    const thumbFormData = new FormData();
                    thumbFormData.append('file', customThumbnailFile);
                    thumbFormData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                    const thumbRes = await fetch(CLOUDINARY_IMAGE_UPLOAD_URL, { method: 'POST', body: thumbFormData });
                    const thumbData = await thumbRes.json();
                    if (!thumbData.secure_url) throw new Error("Error al subir la miniatura personalizada.");
                    thumbnailUrl = thumbData.secure_url;
                }

                const videoFormData = new FormData();
                videoFormData.append('file', videoFileToUpload);
                videoFormData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                const videoRes = await fetch(CLOUDINARY_UPLOAD_URL, { method: 'POST', body: videoFormData });
                const videoData = await videoRes.json();
                if (!videoData.public_id) throw new Error("Error en la subida del video base.");
                const videoPublicId = videoData.public_id;

                // <<< START: CORRECTED LOGIC >>>
                // Generate thumbnail URL from video's public_id BEFORE creating final video URL.
                if(!thumbnailUrl) {
                    thumbnailUrl = `${CLOUDINARY_BASE_URL}${videoPublicId}.jpg`;
                }

                if (selectedMusic.url) {
                    const audioPublicId = `fetch:${btoa(selectedMusic.url)}`;
                    finalVideoUrl = `${CLOUDINARY_BASE_URL}l_audio:${audioPublicId.replace(/\//g, ':')}/fl_layer_apply/f_mp4,vc_h264,ac_aac/${videoPublicId}.mp4`;
                } else {
                    finalVideoUrl = `${CLOUDINARY_BASE_URL}f_mp4,vc_h264,ac_aac/${videoPublicId}.mp4`;
                }
                // <<< END: CORRECTED LOGIC >>>
            }

            const payload = {
                action: 'saveVideoData', usuario: loggedInUser.username,
                titulo: title, descripcion: description,
                videoUrl: finalVideoUrl, thumbnailUrl: thumbnailUrl,
                musicUrl: selectedMusic.url 
            };
            
            const scriptRes = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
            const scriptData = await scriptRes.json();
            if (!scriptData.success) throw new Error(scriptData.message);
            
            showAlert('¡Éxito!', 'Tu contenido ha sido publicado correctamente.', 'success');
            resetUploadProcess();
            navigateToPage('videos');

        } catch (error) {
            showAlert('Error de Publicación', 'No se pudo publicar: ' + error.message, 'error');
        } finally {
            showSpinner(false);
            document.getElementById('upload-submit-btn').disabled = false;
        }
    }

    // --- BÚSQUEDA DE MÚSICA (FREESOUND) ---
    async function searchMusic() {
        const query = document.getElementById('music-search-input').value;
        if (!query) return;
        const resultsContainer = document.getElementById('music-results');
        resultsContainer.innerHTML = '<p>Buscando...</p>';
        const url = `https://freesound.org/apiv2/search/text/?query=${encodeURIComponent(query)}&token=${FREESOUND_API_KEY}&fields=name,previews,id`;
        try {
            const response = await fetch(url);
            const data = await response.json();
            resultsContainer.innerHTML = data.results?.length ? data.results.map(track => `
                <div class="music-item">
                   <button class="btn btn-secondary play-preview-btn" data-url="${track.previews['preview-hq-mp3']}"><i class="fas fa-play"></i></button>
                   <div class="music-item-info"><div class="music-item-name">${track.name}</div></div>
                   <button class="btn btn-primary select-music-btn" data-name="${track.name}" data-url="${track.previews['preview-hq-mp3']}">Elegir</button>
                </div>`).join('') : '<p>No se encontraron resultados.</p>';
        } catch (error) { resultsContainer.innerHTML = '<p>Error al buscar música.</p>'; }
    }
    function handleMusicListClick(e) {
        const musicPreviewPlayer = document.getElementById('music-preview-player');
        if(e.target.closest('.play-preview-btn')) {
            const btn = e.target.closest('.play-preview-btn');
            const url = btn.dataset.url; const icon = btn.querySelector('i');
            if (musicPreviewPlayer.src === url && !musicPreviewPlayer.paused) {
                musicPreviewPlayer.pause(); icon.className = 'fas fa-play';
            } else {
                document.querySelectorAll('.play-preview-btn i').forEach(i => i.className = 'fas fa-play');
                musicPreviewPlayer.src = url; musicPreviewPlayer.play(); icon.className = 'fas fa-pause';
            }
        }
        if(e.target.closest('.select-music-btn')) {
            const btn = e.target.closest('.select-music-btn');
            selectedMusic = { name: btn.dataset.name, url: btn.dataset.url };
            document.getElementById('selected-music-info').textContent = `Música: ${selectedMusic.name}`;
            document.getElementById('music-modal').style.display = 'none';
            musicPreviewPlayer.pause(); musicPreviewPlayer.src = '';
        }
    }

    // --- HELPERS Y EVENTOS ---
    function showSpinner(show) { document.getElementById('loading-spinner').style.display = show ? 'flex' : 'none'; }
    function setupEventListeners() {
        document.querySelectorAll('.nav-item[data-page]').forEach(i => i.addEventListener('click', () => navigateToPage(i.dataset.page)));
        document.getElementById('video-list-container').addEventListener('click', handleVideoListClick);
        document.getElementById('cancel-edit-btn').addEventListener('click', () => document.getElementById('edit-video-modal').style.display = 'none');
        document.getElementById('save-edit-btn').addEventListener('click', saveVideoEdit);
        document.getElementById('upload-gallery-btn').addEventListener('click', () => document.getElementById('gallery-file-input').click());
        document.getElementById('gallery-file-input').addEventListener('change', e => e.target.files[0] && showPreviewScreen(e.target.files[0]));
        
        // Eventos de la Cámara
        document.getElementById('take-photo-btn').addEventListener('click', () => { currentFacingMode = 'user'; openCamera('photo', currentFacingMode); });
        document.getElementById('record-video-btn').addEventListener('click', () => { currentFacingMode = 'user'; openCamera('video', currentFacingMode); });
        document.getElementById('camera-cancel-btn').addEventListener('click', closeCamera);
        document.getElementById('record-btn').addEventListener('click', () => (mediaRecorder?.state === 'recording') ? stopRecording() : startRecording());
        document.getElementById('shutter-btn').addEventListener('click', takePhoto);
        document.getElementById('switch-camera-btn').addEventListener('click', switchCamera);
        document.getElementById('flash-btn').addEventListener('click', toggleFlash);

        document.querySelectorAll('.zoom-controls .zoom-option').forEach(b => {
            b.addEventListener('click', () => {
                const zoom = parseFloat(b.dataset.zoom);
                applyZoom(zoom);
                document.querySelectorAll('.zoom-controls .zoom-option').forEach(btn => btn.classList.remove('active'));
                b.classList.add('active');
            });
        });
        
        document.querySelectorAll('.duration-controls button').forEach(b => b.addEventListener('click', () => {
            document.querySelectorAll('.duration-controls button').forEach(btn => btn.classList.remove('active'));
            b.classList.add('active'); selectedDuration = parseInt(b.dataset.duration, 10);
        }));

        // Eventos de Subida y Previsualización
        document.getElementById('preview-cancel-btn').addEventListener('click', resetUploadProcess);
        document.getElementById('preview-next-btn').addEventListener('click', () => { 
            document.getElementById('preview-section').style.display = 'none'; 
            document.getElementById('thumbnail-form-group').classList.remove('hidden');
            document.getElementById('open-music-modal-btn').classList.remove('hidden');
            document.getElementById('upload-section').style.display = 'flex'; 
        });
        document.getElementById('upload-cancel-btn').addEventListener('click', resetUploadProcess);
        document.getElementById('upload-submit-btn').addEventListener('click', submitUpload);
        
        // Thumbnail selection events
        document.getElementById('thumb-option-auto').addEventListener('click', () => {
            document.getElementById('thumb-option-auto').classList.add('selected');
            document.getElementById('thumb-option-custom').classList.remove('selected');
            document.getElementById('thumbnail-preview').classList.add('hidden');
            customThumbnailFile = null;
        });
        document.getElementById('thumb-option-custom').addEventListener('click', () => {
             document.getElementById('thumbnail-file-input').click();
        });
        document.getElementById('thumbnail-file-input').addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                customThumbnailFile = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (ev) => {
                    document.getElementById('thumbnail-preview').src = ev.target.result;
                    document.getElementById('thumbnail-preview').classList.remove('hidden');
                    document.getElementById('thumb-option-custom').classList.add('selected');
                    document.getElementById('thumb-option-auto').classList.remove('selected');
                }
                reader.readAsDataURL(customThumbnailFile);
            }
        });

        // Eventos del Modal de Música
        document.getElementById('open-music-modal-btn').addEventListener('click', () => document.getElementById('music-modal').style.display = 'flex');
        document.getElementById('close-music-modal-btn').addEventListener('click', () => { document.getElementById('music-modal').style.display = 'none'; document.getElementById('music-preview-player').pause(); });
        document.getElementById('music-search-btn').addEventListener('click', searchMusic);
        document.getElementById('music-search-input').addEventListener('keypress', (e) => { if (e.key === 'Enter') searchMusic(); });
        document.getElementById('music-results').addEventListener('click', handleMusicListClick);
    }
});
</script>

</body>
</html>